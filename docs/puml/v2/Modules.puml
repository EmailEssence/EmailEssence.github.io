@startuml
title Email Essence Sequence Diagram
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true
skinparam maxMessageSize 250
skinparam style strictuml
skinparam padding 8
skinparam roundcorner 10
skinparam ArrowThickness 3

' Font settings
skinparam defaultFontSize 18
skinparam defaultFontName Helvetica
skinparam defaultTextAlignment center

' Define custom colors to match Architecture.puml
skinparam sequence {
    ArrowColor #bf0618
    ArrowFontSize 20
    ResponseColor #32CD32
    GroupBackgroundColor #FFEBD6
    GroupBodyBackgroundColor #FFF8EF
    
    ' Sequence specific font settings
    ParticipantFontSize 20
    ParticipantFontStyle plain
    GroupFontSize 20
    GroupFontStyle bold
    MessageFontSize 16
    MessageFontStyle bold
    TitleFontSize 20
    TitleFontStyle bold
}

actor User as Instance
box "Frontend Layer" #FFB6C1
    participant "Client UI" as ClientUI #FF69B4
    participant "Auth Handler" as Auth #FF69B4
    participant "Email Handler" as EmailHandler #FF69B4
end box

box "Backend Layer" #98FB98
    participant "FastAPI\nCore" as FastAPI #228B22
    participant "Auth & User\nAPI" as AuthUserAPI #228B22
    participant "Email & Summary\nAPI" as EmailAPI #228B22
    participant "Auth & User\nService" as AuthUserService #4169E1
    participant "Email & Summary\nService" as EmailService #4169E1
end box

database "MongoDB" as MongoDB #CD853F

box "External Services" #F0E68C
    participant "Google\nServices" as Google
    participant "OpenAI\nAPI" as OpenAIAPI
end box

== Authentication & Profile ==
Instance [#bf0618]-> Auth: Login
activate Auth
Auth [#bf0618]-> AuthUserAPI: OAuth Request
AuthUserAPI [#FFA500]-> AuthUserService: Process Auth
AuthUserService [#FFA500]-> Google: OAuth Flow
Google [#32CD32]-> AuthUserService: Tokens
AuthUserService [#FFA500]-> MongoDB: Store Auth Data
AuthUserService [#FFA500]-> MongoDB: Create/Get User
MongoDB [#32CD32]-> AuthUserService: User Profile
AuthUserService [#32CD32]-> AuthUserAPI: Auth Complete
AuthUserAPI [#32CD32]-> Auth: Login Success
deactivate Auth
Auth [#32CD32]-> Instance: Authenticated

== Email & Summary Operations ==
Instance [#bf0618]-> EmailHandler: Request Content
activate EmailHandler
EmailHandler [#bf0618]-> EmailAPI: Fetch Data
EmailAPI [#FFA500]-> EmailService: Process Request
EmailService [#FFA500]-> AuthUserService: Validate Token
AuthUserService [#32CD32]-> EmailService: Token Valid

group Email Retrieval
    EmailService [#FFA500]-> Google: IMAP Connection
    Google [#32CD32]-> EmailService: Messages
    EmailService [#FFA500]-> MongoDB: Store Emails
end

group Summary Generation [If Requested]
    EmailService [#FFA500]-> OpenAIAPI: Generate Summary
    OpenAIAPI [#32CD32]-> EmailService: Summary
    EmailService [#FFA500]-> MongoDB: Cache Summary
end

MongoDB [#32CD32]-> EmailService: Storage Status
EmailService [#32CD32]-> EmailAPI: Processed Data
EmailAPI [#32CD32]-> EmailHandler: Content Ready
deactivate EmailHandler
EmailHandler [#32CD32]-> Instance: Display Content

== User Preferences ==
Instance [#bf0618]-> ClientUI: Update Settings
activate ClientUI
ClientUI [#bf0618]-> AuthUserAPI: Update Request
AuthUserAPI [#FFA500]-> AuthUserService: Process Update
AuthUserService [#FFA500]-> MongoDB: Store Settings
MongoDB [#32CD32]-> AuthUserService: Update Status
AuthUserService [#32CD32]-> AuthUserAPI: Settings Updated
AuthUserAPI [#32CD32]-> ClientUI: Changes Saved
deactivate ClientUI
ClientUI [#32CD32]-> Instance: Settings Applied

@enduml 